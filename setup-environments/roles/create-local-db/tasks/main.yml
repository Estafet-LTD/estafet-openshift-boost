---

- debug:
    var: params
    verbosity: 0

- name: Create the {{ params.app }} database on PostgreSQL Pod
  shell: 'oc exec {{db_pod}} -- /bin/sh -i -c "createdb {{ project }}-{{ params.app }}"'
  register: command_result
  failed_when: "'exists' not in command_result.stderr and command_result.rc != 0"
  changed_when: "'exists' not in command_result.stderr"
  tags:
    - openshift
    - postgresql

- name: Copy ddl to PostgreSQL Pod
  shell: 'oc rsync --no-perms=true --include="*.ddl" --exclude="*" {{ workdir }}/{{ params.repo }}/ddl/ {{db_pod}}:/tmp'
  register: command_result
  when: params.reset_db 
  failed_when: "'exists' not in command_result.stderr and command_result.rc != 0"
  changed_when: "'exists' not in command_result.stderr"
  tags:
    - openshift
    - postgresql
    
- name: Copy liqubase ddl to PostgreSQL Pod
  shell: 'oc rsync --no-perms=true --include="*.ddl" --exclude="*" {{ boost_ddl }}/ {{pod}}:/tmp'
  register: command_result
  when: params.reset_db 
  failed_when: "'exists' not in command_result.stderr and command_result.rc != 0"
  changed_when: "'exists' not in command_result.stderr"
  tags:
    - openshift
    - postgresql  

- name: Execute Drop ddl on PostgreSQL Pod
  shell: 'oc exec {{db_pod}} -- /bin/sh -i -c "psql -d {{ project }}-{{ params.app }} -U postgres -f /tmp/drop-{{ params.app }}-db.ddl"'
  register: command_result
  when: params.reset_db
  failed_when: "'exists' not in command_result.stderr and command_result.rc != 0"
  changed_when: "'exists' not in command_result.stderr"
  tags:
    - openshift
    - postgresql
    
- name: Drop liquibase on PostgreSQL Pod
  shell: 'oc exec {{db_pod}} -- /bin/sh -i -c "psql -d {{ project }}-{{ params.app }} -U postgres -f /tmp/drop-liquibase-db.ddl"'
  register: command_result
  when: params.reset_db
  failed_when: "'exists' not in command_result.stderr and command_result.rc != 0"
  changed_when: "'exists' not in command_result.stderr"
  tags:
    - openshift
    - postgresql    