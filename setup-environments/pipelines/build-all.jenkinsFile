node {
	
	properties([
	  parameters([
	     string(name: 'GITHUB'), string(name: 'PRODUCT'), string(name: 'REPO'),
	  ]),
	  disableConcurrentBuilds()
	])	

	def microservices		
	
	stage("checkout") {
		git branch: "master", url: "https://github.com/${params.GITHUB}/${params.REPO}"
	}
	
	stage("read the microservices definition") {
		def yml = readYaml file: "setup-environments/vars/microservices-vars.yml"
		microservices = yml.microservices
	}

	stage ('build all microservices') {
		microservices.each { microservice ->
			openshiftBuild namespace: "${params.PRODUCT}-cicd", buildConfig: "build-${microservice.name}", env : [ [ name : 'GITHUB', value : params.GITHUB ], [ name : 'PRODUCT', value : params.PRODUCT ], [ name : 'REPO', value : "${microservice.repo}" ], [ name : 'MICROSERVICE', value : "${microservice.name}" ] ], waitTime: "1800000"
			openshiftVerifyBuild namespace: "${params.PRODUCT}-cicd", buildConfig: "build-${microservice.name}", waitTime: "1800000" 
	  }	
	}
}
