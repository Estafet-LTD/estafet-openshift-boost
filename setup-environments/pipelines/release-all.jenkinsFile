node {
	
	properties([
	  parameters([
	     string(name: 'GITHUB'), 
	     string(name: 'PRODUCT'), 
	     string(name: 'REPO'),
	  ])
	])	

	def microservices		
	
	stage("checkout") {
		git credentialsId: "git", branch: "master", url: "https://github.com/${params.GITHUB}/${params.REPO}"
	}
	
	stage("read the microservices definition") {
		def yml = readYaml file: "setup-environments/vars/microservices-vars.yml"
		microservices = yml.microservices
	}

	stage ('build all microservices') {
		microservices.each { microservice ->
			sh "oc start-build release-${microservice.name} -e GITHUB=${params.GITHUB} -e PRODUCT=${params.PRODUCT} -e PRODUCT_REPO=${params.REPO} -e REPO=${microservice.repo} -e MICROSERVICE=${microservice.name} --wait -n ${params.PRODUCT}-cicd"
	  }	
	}
}